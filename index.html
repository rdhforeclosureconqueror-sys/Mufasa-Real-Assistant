<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mufasa Real Assistant</title>
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#050505; --gold:#d4af37; --text:#f2f2f2; --muted:#bdbdbd;
      --card: rgba(0,0,0,.35);
      --line: rgba(212,175,55,.35);
      --chip: rgba(212,175,55,.12);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 20% 10%, rgba(193,18,31,.18), transparent 55%),
        radial-gradient(1100px 650px at 80% 15%, rgba(27,127,58,.18), transparent 55%),
        radial-gradient(900px 550px at 50% 95%, rgba(212,175,55,.12), transparent 55%),
        var(--bg);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .top{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border:1px solid var(--line); border-radius:16px; padding:14px;
      background:rgba(0,0,0,.35);
      flex-wrap:wrap;
    }
    .title{ font-weight:900; letter-spacing:.4px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .right{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{
      border:1px solid rgba(212,175,55,.6);
      background:rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
    }
    .btn:hover{ background:rgba(212,175,55,.12); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .grid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background:var(--card);
    }

    textarea{
      width:100%;
      min-height:120px;
      background:#000;
      color:var(--text);
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      resize:vertical;
      font-size:15px;
      line-height:1.3;
    }

    .row{ display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .chip{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      font-size:12px;
      color:var(--muted);
    }

    .chat{
      margin-top:10px;
      background:#000;
      border-radius:12px;
      padding:12px;
      max-height:420px;
      overflow:auto;
      border:1px solid var(--line);
    }
    .msg{ margin-bottom:12px; white-space:pre-wrap; }
    .user{ color:#9fd3ff; font-weight:700; }
    .ai{ color:#b7ffcc; }

    .prompts button{
      display:block;
      width:100%;
      text-align:left;
      margin:8px 0;
    }

    .videoWrap{
      margin-top:12px;
      display:none;
    }
    video{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:#000;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="top">
    <div>
      <div class="title">ü¶Å Mufasa Real Assistant</div>
      <div class="sub">Static Site ‚Ä¢ Talks to Ma‚Äôat API</div>
      <div class="sub" id="apiLabel"></div>
    </div>

    <div class="right">
      <button class="btn" id="micBtn">üé§ Mic</button>
      <button class="btn" id="ttsBtn">üîä Speak Reply</button>
      <button class="btn" id="slideshowBtn">üéûÔ∏è Slideshow</button>
      <button class="btn" id="langBtn">üåç English</button>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div class="panel">
      <textarea id="input" placeholder="Ask Mufasa / Ma‚Äôat anything‚Ä¶ (Black history, culture, fitness coaching)"></textarea>

      <div class="row">
        <button class="btn" id="sendBtn">Send</button>
        <span class="chip" id="statusChip">Ready</span>
      </div>

      <div class="chat" id="chat"></div>

      <!-- Slideshow video output -->
      <div class="videoWrap" id="videoWrap">
        <div class="row" style="margin-top:0;">
          <span class="chip">Slideshow Output</span>
          <button class="btn" id="closeVideoBtn">‚úñ Close</button>
        </div>
        <video id="slideVideo" controls playsinline></video>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel prompts">
      <strong>Quick Prompts (tap ‚Üí auto-send)</strong>
      <button class="btn">Explain the Mali Empire in 6 key facts</button>
      <button class="btn">Give me a Haitian Revolution timeline</button>
      <button class="btn">Top Black inventors and what they built</button>
      <button class="btn">Teach me Ancient Africa: 5 civilizations</button>
      <button class="btn">From Timbuktu to Harlem: the knowledge flow</button>
    </div>

  </div>
</div>

<script>
/* ================= CONFIG ================= */
/* IMPORTANT: This MUST be your API service URL (the Web Service). */
const API_BASE = "https://mufasa-real-assistant-api.onrender.com";

/* ================= STATE ================= */
let lang = "en";           // UI language toggle (does not change Ma‚Äôat logic unless you add it server-side)
let lastAnswerText = "";   // used for TTS speak
let userId = localStorage.getItem("mufasa_user_id") || ("user_" + Math.random().toString(16).slice(2));
localStorage.setItem("mufasa_user_id", userId);

/* ================= ELEMENTS ================= */
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const statusChip = document.getElementById("statusChip");
const apiLabel = document.getElementById("apiLabel");
apiLabel.textContent = "API: " + API_BASE;

/* ================= HELPERS ================= */
function setStatus(s){ statusChip.textContent = s; }

function addMsg(label, text, cls){
  const div = document.createElement("div");
  div.className = "msg";
  const a = document.createElement("div");
  a.className = cls;
  a.textContent = label;
  const b = document.createElement("div");
  b.textContent = text;
  div.appendChild(a);
  div.appendChild(b);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function safeJson(resp){
  const ct = (resp.headers.get("content-type") || "").toLowerCase();
  if(ct.includes("application/json")) return await resp.json();
  const text = await resp.text();
  return { raw: text };
}

/* ================= ASK (matches your /ask schema) ================= */
async function ask(question){
  addMsg("You:", question, "user");
  setStatus("Thinking‚Ä¶");

  const body = {
    question,
    user_id: userId,
    mode: "chat",
    context: JSON.stringify({ lang, source: "static_site" })
  };

  const r = await fetch(API_BASE + "/ask", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });

  if(!r.ok){
    const j = await safeJson(r);
    setStatus("Error");
    addMsg("API Error:", (j.detail || j.raw || JSON.stringify(j)), "ai");
    return;
  }

  const j = await r.json();
  const answer = j.answer || "(No answer field returned)";
  lastAnswerText = answer;

  addMsg("Ma‚Äôat:", answer, "ai");
  setStatus("Ready");
}

/* ================= QUICK PROMPTS (tap ‚Üí auto-send) ================= */
document.querySelectorAll(".prompts button").forEach(b=>{
  b.onclick = ()=>{
    const q = b.textContent.trim();
    input.value = q;
    ask(q);
  };
});

/* ================= SEND ================= */
document.getElementById("sendBtn").onclick = ()=>{
  const q = input.value.trim();
  if(q) ask(q);
};

/* ================= MIC (speech-to-text) ================= */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec;
if(SR){
  rec = new SR();
  rec.lang = "en-US";
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  rec.onresult = e=>{
    const text = e.results[0][0].transcript;
    input.value = text;
    ask(text);
  };
  rec.onerror = () => setStatus("Mic error");
}

document.getElementById("micBtn").onclick = ()=>{
  if(!rec){ alert("Mic not supported on this browser"); return; }
  setStatus("Listening‚Ä¶");
  rec.start();
};

/* ================= TTS (uses your /voice/tts) ================= */
document.getElementById("ttsBtn").onclick = async ()=>{
  if(!lastAnswerText){ alert("No assistant reply to speak yet."); return; }
  setStatus("Speaking‚Ä¶");

  const fd = new FormData();
  fd.append("text", lastAnswerText);

  const r = await fetch(API_BASE + "/voice/tts", { method:"POST", body: fd });
  if(!r.ok){
    setStatus("TTS error");
    return;
  }
  const blob = await r.blob();
  const url = URL.createObjectURL(blob);

  const audio = new Audio(url);
  // iOS requires user gesture (this button click counts)
  await audio.play().catch(()=>{});
  setStatus("Ready");
};

/* ================= SLIDESHOW (matches your /media/slideshow) ================= */
const videoWrap = document.getElementById("videoWrap");
const slideVideo = document.getElementById("slideVideo");
document.getElementById("closeVideoBtn").onclick = ()=>{
  slideVideo.pause();
  slideVideo.removeAttribute("src");
  videoWrap.style.display = "none";
};

document.getElementById("slideshowBtn").onclick = async ()=>{
  const text = input.value.trim();
  if(!text){ alert("Type a prompt first (this becomes the slideshow text)."); return; }

  setStatus("Rendering slideshow‚Ä¶");

  const payload = { text, title: "Prince of Pan-Africa", max_slides: 8 };

  const r = await fetch(API_BASE + "/media/slideshow", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  if(!r.ok){
    setStatus("Slideshow error");
    const j = await safeJson(r);
    addMsg("Slideshow Error:", (j.detail || j.raw || JSON.stringify(j)), "ai");
    return;
  }

  const ct = (r.headers.get("content-type") || "").toLowerCase();

  // If MP4 returned, play it
  if(ct.includes("video/mp4")){
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    slideVideo.src = url;
    videoWrap.style.display = "block";
    slideVideo.play().catch(()=>{});
    setStatus("Ready");
    return;
  }

  // Otherwise JSON storyboard fallback
  const j = await r.json();
  setStatus("Storyboard mode");
  addMsg("Slideshow:", j.message || "Storyboard returned (no MP4 renderer installed).", "ai");

  if(Array.isArray(j.storyboard)){
    const asText = j.storyboard.map(s => `Slide ${s.slide}: ${s.text}`).join("\n\n");
    addMsg("Storyboard:", asText, "ai");
  }
};

/* ================= LANGUAGE (UI only) ================= */
document.getElementById("langBtn").onclick = (e)=>{
  if(lang === "en"){ lang="sw"; e.target.textContent="Swahili"; }
  else if(lang === "sw"){ lang="yo"; e.target.textContent="Yoruba"; }
  else{ lang="en"; e.target.textContent="English"; }
};
</script>

</body>
</html>
