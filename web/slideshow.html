<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mufasa ‚Äî Answer Slideshow</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#050505;
      --panel:#0c0c0c;
      --line:#d4af37;
      --red:#c1121f;
      --green:#1b7f3a;
      --text:#f4f4f4;
      --muted:#bdbdbd;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 15% 5%, rgba(193,18,31,.18), transparent 55%),
        radial-gradient(1200px 700px at 85% 15%, rgba(27,127,58,.18), transparent 55%),
        radial-gradient(1000px 600px at 50% 95%, rgba(212,175,55,.10), transparent 55%),
        var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    .top{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:12px 14px;
      border:1px solid rgba(212,175,55,.55);
      border-radius:14px;
      background: linear-gradient(180deg, rgba(12,12,12,.92), rgba(12,12,12,.68));
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:16px;letter-spacing:.5px}
    .title .sub{font-size:12px;color:var(--muted)}
    .btn{
      appearance:none;
      border: 1px solid rgba(212,175,55,.65);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
    }
    .btn:hover{background: rgba(212,175,55,.10); border-color: rgba(212,175,55,.95);}
    .btn.red{ border-color: rgba(193,18,31,.75); }
    .btn.red:hover{ background: rgba(193,18,31,.12); border-color: rgba(193,18,31,.95); }
    .btn.green{ border-color: rgba(27,127,58,.75); }
    .btn.green:hover{ background: rgba(27,127,58,.12); border-color: rgba(27,127,58,.95); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(12,12,12,.9), rgba(12,12,12,.65));
      border: 1px solid rgba(212,175,55,.45);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }

    .stage{
      position:relative;
      min-height: 520px;
      border-radius:14px;
      border:1px solid rgba(212,175,55,.35);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }

    .progress{
      position:absolute;left:0;top:0;height:6px;width:0%;
      background: linear-gradient(90deg, var(--red), var(--line), var(--green));
      transition: width .25s linear;
    }

    .slide{
      position:absolute;inset:0;
      padding:26px 22px;
      display:flex;flex-direction:column;gap:14px;
      opacity:0;
      transform: translateX(14px);
      transition: opacity .25s ease, transform .25s ease;
    }
    .slide.active{
      opacity:1;
      transform: translateX(0px);
    }

    .kicker{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(212,175,55,.35);
      background: rgba(0,0,0,.20);
      padding:7px 10px;border-radius:999px;
      width:fit-content;
      font-size:12px;color:var(--muted);
    }

    .slide h2{
      margin:0;
      font-size:24px;
      line-height:1.1;
      letter-spacing:.4px;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
    }

    ul{margin:0;padding-left:20px;color:var(--text);line-height:1.4}
    li{margin-bottom:8px}

    .footerBar{
      position:absolute;left:0;right:0;bottom:0;
      padding:12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.55));
    }
    .meta{font-size:12px;color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    audio{ width:100%; margin-top:10px; }
    textarea{
      width:100%;
      min-height:84px;
      resize:vertical;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(212,175,55,.45);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>üéûÔ∏è Mufasa Answer Slideshow</h1>
        <div class="sub">Turns your question + answer into clean slides (browser ‚Äúvideo style‚Äù).</div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="index.html">‚¨ÖÔ∏è Back</a>
        <button class="btn green" id="btnGenerate">Generate Slides</button>
        <button class="btn red" id="btnAuto" disabled>‚ñ∂Ô∏è Auto-Play</button>
        <button class="btn" id="btnRead" disabled>üîä Read Slides</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="stage" id="stage">
          <div class="progress" id="progress"></div>
          <div class="slide active" id="placeholder">
            <div class="kicker">Ready</div>
            <h2>Load a question to generate slides.</h2>
            <ul>
              <li>Go back and ask Mufasa a question, then click ‚ÄúüéûÔ∏è Slideshow‚Äù.</li>
              <li>Or paste a question in the box on the right and hit ‚ÄúGenerate Slides‚Äù.</li>
            </ul>
          </div>

          <div class="footerBar">
            <div class="meta" id="meta">0 / 0</div>
            <div class="controls">
              <button class="btn" id="btnPrev" disabled>‚üµ Prev</button>
              <button class="btn" id="btnNext" disabled>Next ‚ü∂</button>
              <button class="btn" id="btnStop" disabled>‚èπ Stop</button>
            </div>
          </div>
        </div>

        <audio id="ttsAudio" controls></audio>
      </div>

      <div class="card">
        <div class="kicker">Input</div>
        <h2 style="margin-top:10px;">Question</h2>
        <textarea id="qBox" placeholder="Type a question here (or come from the main page)..."></textarea>

        <div class="kicker" style="margin-top:12px;">Settings</div>
        <p style="color:var(--muted);font-size:12.5px;line-height:1.35;margin-top:10px;">
          Auto-play shows each slide for a few seconds. ‚ÄúRead Slides‚Äù uses Ma‚Äôat TTS.
        </p>
      </div>
    </div>
  </div>

  <script>
    // must match your main site
    const MAAT_BASE_URL = "https://mufasabrain.onrender.com";
    const STORYBOARD_URL = `${MAAT_BASE_URL}/storyboard`;
    const TTS_URL = `${MAAT_BASE_URL}/voice/tts`;

    const stage = document.getElementById("stage");
    const progress = document.getElementById("progress");
    const meta = document.getElementById("meta");
    const qBox = document.getElementById("qBox");

    const btnGenerate = document.getElementById("btnGenerate");
    const btnAuto = document.getElementById("btnAuto");
    const btnRead = document.getElementById("btnRead");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const btnStop = document.getElementById("btnStop");

    const ttsAudio = document.getElementById("ttsAudio");

    let slides = [];
    let idx = 0;
    let timer = null;
    let slideSeconds = 4;

    function clearSlidesFromStage(){
      [...stage.querySelectorAll(".slide")].forEach(el=>{
        if(el.id !== "placeholder") el.remove();
      });
      document.getElementById("placeholder").style.display = "block";
    }

    function renderSlides(){
      clearSlidesFromStage();
      document.getElementById("placeholder").style.display = "none";

      slides.forEach((s, i)=>{
        const el = document.createElement("div");
        el.className = "slide" + (i === 0 ? " active" : "");
        el.dataset.index = String(i);

        const kicker = document.createElement("div");
        kicker.className = "kicker";
        kicker.textContent = `Slide ${i+1} of ${slides.length}`;
        el.appendChild(kicker);

        const h2 = document.createElement("h2");
        h2.textContent = s.heading || `Slide ${i+1}`;
        el.appendChild(h2);

        const ul = document.createElement("ul");
        (s.bullets || []).forEach(b=>{
          const li = document.createElement("li");
          li.textContent = b;
          ul.appendChild(li);
        });
        el.appendChild(ul);

        stage.appendChild(el);
      });

      idx = 0;
      updateUI();
    }

    function setActive(i){
      idx = Math.max(0, Math.min(i, slides.length - 1));
      [...stage.querySelectorAll(".slide")].forEach(el=>{
        const n = Number(el.dataset.index || -1);
        if(n === idx) el.classList.add("active");
        else el.classList.remove("active");
      });
      updateUI();
    }

    function updateUI(){
      meta.textContent = slides.length ? `${idx+1} / ${slides.length}` : `0 / 0`;
      btnPrev.disabled = !(slides.length && idx > 0);
      btnNext.disabled = !(slides.length && idx < slides.length - 1);
      btnAuto.disabled = !slides.length;
      btnRead.disabled = !slides.length;
      btnStop.disabled = !timer;

      const pct = slides.length ? ((idx+1)/slides.length)*100 : 0;
      progress.style.width = `${pct}%`;
    }

    function stopAuto(){
      if(timer){ clearInterval(timer); timer = null; }
      updateUI();
    }

    function startAuto(){
      stopAuto();
      timer = setInterval(()=>{
        if(idx >= slides.length - 1){
          stopAuto();
          return;
        }
        setActive(idx + 1);
      }, slideSeconds * 1000);
      updateUI();
    }

    async function generate(){
      stopAuto();
      const q = (qBox.value || "").trim();
      if(!q){
        alert("Type a question first.");
        return;
      }

      btnGenerate.disabled = true;
      try{
        const r = await fetch(STORYBOARD_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            question: q,
            user_id: "rashad",
            max_slides: 8
          })
        });
        if(!r.ok){
          const t = await r.text();
          throw new Error(t || "Storyboard failed");
        }
        const data = await r.json();
        slides = data.slides || [];
        if(!slides.length){
          throw new Error("No slides returned.");
        }
        renderSlides();
      }catch(err){
        console.error(err);
        alert("Error: " + (err?.message || err));
      }finally{
        btnGenerate.disabled = false;
      }
    }

    async function readSlides(){
      if(!slides.length) return;

      // make one narration string
      const narration =
        slides.map((s,i)=>{
          const head = s.heading ? `${s.heading}.` : `Slide ${i+1}.`;
          const bullets = (s.bullets || []).join(" ");
          return `${head} ${bullets}`;
        }).join("\n\n");

      btnRead.disabled = true;
      try{
        const form = new FormData();
        form.append("text", narration);
        const r = await fetch(TTS_URL, { method:"POST", body: form });
        if(!r.ok){
          const t = await r.text();
          throw new Error(t || "TTS failed");
        }
        const audioBlob = await r.blob();
        const url = URL.createObjectURL(audioBlob);
        ttsAudio.src = url;
        await ttsAudio.play();
      }catch(err){
        console.error(err);
        alert("TTS Error: " + (err?.message || err));
      }finally{
        btnRead.disabled = !slides.length;
      }
    }

    btnGenerate.addEventListener("click", generate);
    btnPrev.addEventListener("click", ()=> setActive(idx - 1));
    btnNext.addEventListener("click", ()=> setActive(idx + 1));
    btnStop.addEventListener("click", stopAuto);
    btnAuto.addEventListener("click", startAuto);
    btnRead.addEventListener("click", readSlides);

    // Pull question from query param
    const params = new URLSearchParams(location.search);
    const qParam = params.get("q");
    if(qParam){
      qBox.value = decodeURIComponent(qParam);
    }
  </script>
</body>
</html>
