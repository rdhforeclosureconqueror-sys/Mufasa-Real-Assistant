// portal.js â€” shared logic for all portals

function initPortal(portalCode, firstPrompt){
  const chatBox=document.getElementById("chat-box");
  const promptEl=document.getElementById("prompt");
  const sendBtn=document.getElementById("send");
  const speakBtn=document.getElementById("speak");
  const journal=document.getElementById("journal");
  const progressBar=document.querySelector("#progressbar div");
  const progressText=document.getElementById("progress-text");
  const calendar=document.getElementById("calendar");

  const keyBase=portalCode+"_";
  let progress=parseInt(localStorage.getItem(keyBase+"progress")||"1");
  let notes=localStorage.getItem(keyBase+"journal")||"";
  journal.value=notes;

  // Calendar build
  for(let i=1;i<=30;i++){
    const d=document.createElement("div");
    d.textContent=i;
    if(i<=progress)d.classList.add("done");
    d.addEventListener("click",()=>setProgress(i));
    calendar.appendChild(d);
  }

  function setProgress(val){
    progress=Math.min(30,Math.max(1,val));
    localStorage.setItem(keyBase+"progress",progress);
    updateProgress();
  }

  function updateProgress(){
    const pct=(progress/30)*100;
    progressBar.style.width=pct+"%";
    progressText.textContent=`Day ${progress} of 30`;
    document.querySelectorAll(".calendar div").forEach((d,i)=>{
      d.classList.toggle("done",i<progress);
    });
  }

  updateProgress();

  // Journal auto-save
  journal.addEventListener("input",()=>{
    localStorage.setItem(keyBase+"journal",journal.value);
  });

  // Chat
  async function sendMessage(text){
    if(!text.trim())return;
    const msg=document.createElement("div");
    msg.textContent="ðŸ§ "+text;
    chatBox.appendChild(msg);
    chatBox.scrollTop=chatBox.scrollHeight;
    promptEl.value="";
    const payload={question:`${portalCode}\n${text}`};
    try{
      const res=await fetch("/ask",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      const data=await res.json();
      const reply=document.createElement("div");
      reply.textContent="ðŸ¦ "+(data.answer||"No response.");
      chatBox.appendChild(reply);
      chatBox.scrollTop=chatBox.scrollHeight;
      setProgress(progress+1);
    }catch(e){
      const err=document.createElement("div");
      err.textContent="âš ï¸ Connection error.";
      chatBox.appendChild(err);
    }
  }

  sendBtn.onclick=()=>sendMessage(promptEl.value);
  promptEl.addEventListener("keydown",e=>{
    if(e.key==="Enter")sendMessage(promptEl.value);
  });

  // Speech
  speakBtn.onclick=()=>{
    const synth=window.speechSynthesis;
    const utter=new SpeechSynthesisUtterance(promptEl.value||firstPrompt);
    utter.voice=synth.getVoices().find(v=>v.lang.startsWith("en")&&v.name.toLowerCase().includes("female"))||null;
    synth.speak(utter);
  };

  // preload first prompt
  if(chatBox.innerText.trim()===""){
    sendMessage(firstPrompt);
  }
}
