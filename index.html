<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mufasa Slideshow</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#050505; --gold:#d4af37; --text:#f2f2f2; --muted:#bdbdbd;
      --card: rgba(0,0,0,.30);
      --line: rgba(212,175,55,.35);
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 20% 10%, rgba(193,18,31,.16), transparent 55%),
        radial-gradient(1100px 650px at 80% 15%, rgba(27,127,58,.16), transparent 55%),
        radial-gradient(900px 550px at 50% 95%, rgba(212,175,55,.12), transparent 55%),
        var(--bg);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.25);
    }
    .title{ font-weight:900; letter-spacing:.4px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:4px; }
    .btn{
      appearance:none;
      border:1px solid rgba(212,175,55,.55);
      background: rgba(0,0,0,.22);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .deck{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(0,0,0,.18);
      padding:14px;
    }
    .slide{
      border:1px solid rgba(212,175,55,.22);
      border-radius:18px;
      background: var(--card);
      padding:16px;
      min-height:320px;
    }
    .slide h2{ margin:0 0 10px; color: rgba(212,175,55,.95); }
    ul{ margin:0; padding-left:18px; }
    li{ margin:6px 0; line-height:1.35; }
    .narr{ margin-top:12px; color:var(--muted); line-height:1.4; }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center; }
    .counter{ color:var(--muted); font-weight:700; }
    audio{ width:100%; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">üéûÔ∏è Mufasa Slideshow</div>
        <div class="sub" id="meta">Loading‚Ä¶</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="prev">‚¨ÖÔ∏è Prev</button>
        <button class="btn" id="next">Next ‚û°Ô∏è</button>
        <button class="btn" id="speak">üîä Speak Slide</button>
      </div>
    </div>

    <div class="deck">
      <div class="slide">
        <h2 id="stitle">‚Ä¶</h2>
        <ul id="bullets"></ul>
        <div class="narr" id="narr"></div>
        <div class="controls">
          <span class="counter" id="counter"></span>
        </div>
        <audio id="ttsAudio" controls></audio>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const id = qs.get("id") || "";
    const api = qs.get("api") || "";
    const meta = document.getElementById("meta");
    const stitle = document.getElementById("stitle");
    const bullets = document.getElementById("bullets");
    const narr = document.getElementById("narr");
    const counter = document.getElementById("counter");

    const btnPrev = document.getElementById("prev");
    const btnNext = document.getElementById("next");
    const btnSpeak = document.getElementById("speak");
    const ttsAudio = document.getElementById("ttsAudio");

    let deck = null;
    let idx = 0;

    function render(){
      const slides = deck?.deck?.slides || [];
      const s = slides[idx] || {title:"(missing)", bullets:[], narration:""};
      stitle.textContent = s.title || "";
      bullets.innerHTML = "";
      (s.bullets || []).forEach(b=>{
        const li = document.createElement("li");
        li.textContent = b;
        bullets.appendChild(li);
      });
      narr.textContent = s.narration || "";
      counter.textContent = `Slide ${idx+1} / ${slides.length}`;
      btnPrev.disabled = idx <= 0;
      btnNext.disabled = idx >= slides.length - 1;
    }

    async function loadDeck(){
      // first try API fetch
      if(api && id){
        try{
          const r = await fetch(`${api}/storyboard/get?id=${encodeURIComponent(id)}`);
          if(r.ok){
            const j = await r.json();
            deck = j.storyboard;
          }
        }catch(e){}
      }

      // fallback: localStorage
      if(!deck){
        try{
          const raw = localStorage.getItem("lastStoryboard");
          if(raw) deck = JSON.parse(raw).storyboard || JSON.parse(raw);
        }catch(e){}
      }

      if(!deck){
        meta.textContent = "Could not load slideshow. Go back and Create Slideshow again.";
        return;
      }

      meta.textContent = `${deck.deck?.deck_title || "Deck"} ‚Ä¢ id: ${deck.id || id || "n/a"}`;
      render();
    }

    async function speakSlide(){
      const text = `${stitle.textContent}\n\n${narr.textContent}`;
      if(!api){
        alert("Missing api=... parameter.");
        return;
      }
      const form = new FormData();
      form.append("text", text);
      const r = await fetch(`${api}/voice/tts`, { method:"POST", body: form });
      if(!r.ok){
        alert("TTS failed");
        return;
      }
      const blob = await r.blob();
      ttsAudio.src = URL.createObjectURL(blob);
      await ttsAudio.play();
    }

    btnPrev.onclick = ()=>{ idx = Math.max(0, idx-1); render(); };
    btnNext.onclick = ()=>{ idx = idx+1; render(); };
    btnSpeak.onclick = speakSlide;

    loadDeck();
  </script>
</body>
</html>
